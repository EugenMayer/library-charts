suite: portal test
templates:
  - common.yaml
release:
  name: test-release-name
  namespace: test-release-namespace
tests:
  - it: should pass with service default values
    set:
      global: &global
        namespace: ix-ns
        ixChartContext:
          imNotEmpty: true
      enabled: true
      port: 12345
      service:
        my-service:
          enabled: "{{ .Values.enabled }}"
          primary: true
          ports:
            my-port:
              enabled: "{{ .Values.enabled }}"
              primary: true
              port: "{{ .Values.port }}"
      portal:
        main:
          enabled: "{{ .Values.enabled }}"
    asserts:
      - documentIndex: &configMapDoc 1
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: $node_ip
            path: /
            port: "12345"
            protocol: http
            url: http://$node_ip:12345/

  - it: should pass with service loadBalancer values
    set:
      global: *global
      ip: 1.2.3.4
      service:
        my-service:
          enabled: true
          primary: true
          type: LoadBalancer
          loadBalancerIP: "{{ .Values.ip }}"
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
      portal:
        main:
          enabled: true
    asserts:
      - documentIndex: &configMapDoc 1
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: 1.2.3.4
            path: /
            port: "12345"
            protocol: http
            url: http://1.2.3.4:12345/

  - it: should pass with ingress
    set:
      global: *global
      portal:
        main:
          enabled: true
      enabled: true
      host: example.com
      path: /some-path
      operator:
        verify:
          enabled: false
      ingress:
        my-ingress:
          enabled: "{{ .Values.enabled }}"
          primary: true
          integrations:
            traefik:
              enabled: false
          hosts:
            - host: "{{ .Values.host }}"
              paths:
                - path: "{{ .Values.path }}"
      service:
        my-service:
          enabled: true
          primary: true
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
    asserts:
      - documentIndex: &configMapDoc 2
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: example.com
            path: /some-path
            port: "443"
            protocol: https
            url: https://example.com:443/some-path

  - it: should pass with ingress and traefik integration
    set:
      global: *global
      portal:
        main:
          enabled: true
      operator:
        verify:
          enabled: false
      ingress:
        my-ingress:
          enabled: true
          primary: true
          integrations:
            traefik:
              enabled: true
              entrypoints:
                - web
              enableFixedMiddlewares: false
          hosts:
            - host: example.com
              paths:
                - path: /some-path
      service:
        my-service:
          enabled: true
          primary: true
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
    asserts:
      - documentIndex: &configMapDoc 2
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: example.com
            path: /some-path
            port: "80"
            protocol: http
            url: http://example.com:80/some-path

  - it: should pass with ingress and tls and traefik integration
    set:
      global: *global
      portal:
        main:
          enabled: true
      operator:
        verify:
          enabled: false
      ingress:
        my-ingress:
          enabled: true
          primary: true
          integrations:
            traefik:
              enabled: true
              entrypoints:
                - web
              enableFixedMiddlewares: false
          hosts:
            - host: example.com
              paths:
                - path: /some-path
          tls:
            - hosts:
                - example.com
              secretName: example-tls
      service:
        my-service:
          enabled: true
          primary: true
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
    asserts:
      - documentIndex: &configMapDoc 2
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: example.com
            path: /some-path
            port: "443"
            protocol: https
            url: https://example.com:443/some-path

  - it: should pass with ingress and tls and traefik integration
    set:
      global: *global
      portal:
        main:
          enabled: true
      operator:
        verify:
          enabled: false
      ingress:
        my-ingress:
          enabled: true
          primary: true
          integrations:
            traefik:
              enabled: true
              entrypoints:
                - web
              enableFixedMiddlewares: false
          hosts:
            - host: example.com
              paths:
                - path: /some-path
          tls:
            - hosts:
                - example.com
              secretName: example-tls
      service:
        my-service:
          enabled: true
          primary: true
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
    asserts:
      - documentIndex: &configMapDoc 2
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: example.com
            path: /some-path
            port: "443"
            protocol: https
            url: https://example.com:443/some-path

  - it: should pass with ingress and certManager integration and traefik integration
    set:
      global: *global
      portal:
        main:
          enabled: true
      operator:
        verify:
          enabled: false
      ingress:
        my-ingress:
          enabled: true
          primary: true
          integrations:
            certManager:
              enabled: true
              certificateIssuer: some-issuer
            traefik:
              enabled: true
              entrypoints:
                - web
              enableFixedMiddlewares: false
          hosts:
            - host: example.com
              paths:
                - path: /some-path
      service:
        my-service:
          enabled: true
          primary: true
          ports:
            my-port:
              enabled: true
              primary: true
              port: 12345
    asserts:
      - documentIndex: &configMapDoc 2
        isKind:
          of: ConfigMap
      - documentIndex: *configMapDoc
        equal:
          path: metadata.name
          value: tcportal-main
      - documentIndex: *configMapDoc
        equal:
          path: data
          value:
            host: example.com
            path: /some-path
            port: "443"
            protocol: https
            url: https://example.com:443/some-path
